<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% if phase == 'login' %}Login with Image Password{% else %}Set Your Image Password{% endif %}</title>
  <style>
    .grid {
      display: grid;
      grid-template-columns: repeat({{ 6 if phase != 'login' else 4 }}, 80px);
      gap: 10px;
      margin: 20px auto;
      width: max-content;
    }
    .grid img {
      width: 80px;
      height: 80px;
      border: 3px solid transparent;
      cursor: pointer;
    }
    .grid img.selected {
      border-color: blue;
    }
    .center {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2 class="center">
    {% if phase == 'create' %}
    Choose 5 Images

    {% elif phase == 'confirm' %}
    Confirm Your Image Password

    {% else %}
    Login Using Your Image Password
    
    {% endif %}
  </h2>

  <div class="grid" id="imageGrid">
    {% for id in grid %}
      <img src="{{ url_for('static', filename='images/img' ~ id ~ '.jpg') }}"
           data-id="{{ id }}" onclick="selectImage(this)">
    {% endfor %}
  </div>

  <p id="counter" class="center">Selected: 0 / 5</p>

  <div class="center">
    <button onclick="submitSelection()">Submit</button>
    <p id="status"></p>
  </div>

  {% if phase != 'create' and phase != 'confirm' %}
  <a href="{{ url_for('go_to_next') }}">Go to next survey incase you don't remember the Pattern</a>
  {% endif %}

  <script>
    const phase = "{{ phase }}";
    let selected = [];

    function updateCounter() {
    document.getElementById("counter").textContent = `Selected: ${selected.length} / 5`;
    }

    function selectImage(img) {
    const id = img.dataset.id;
    const index = selected.indexOf(id);

    if (index !== -1) {
        selected.splice(index, 1);
        img.classList.remove("selected");
    } else {
        if (selected.length < 5) {
        selected.push(id);
        img.classList.add("selected");
        }
    }

    updateCounter();
    }

    function submitSelection() {
      if (selected.length !== 5) {
        document.getElementById("status").textContent = "Please select exactly 5 images.";
        return;
      }

      const url = phase === 'login' ? "/submit_image_login" : "/submit_image_password";

      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sequence: selected })

      })
      .then(res => res.json())
      .then(data => {
        const status = document.getElementById("status");

        if (data.status === "confirm") {
        // status.textContent = "Now reselect the same 5 images to confirm.";
        // setTimeout(() => window.location.reload(), 2000);  // wait 1.5 seconds
        window.location.reload()
        } else if (data.status === "saved") {
        window.location.href = data.next;
        } else if (data.status === "mismatch") {
        window.location.reload()
        // status.textContent = "Mismatch. Start over.";
        // setTimeout(() => window.location.reload(), 2000);  // wait 1.5 seconds
        } else if (data.success) {
        status.textContent = "Access granted";
        window.location.href = data.next
        // setTimeout(() => window.location.href = data.next, 1000);
        } else {
        window.location.reload()
        status.textContent = data.message || "Access denied";
        }
      });
    }
  </script>

</body>
</html>
